{% extends 'base.html' %}

{% load django_bootstrap5 %}
{% load i18n %}
{% load static %}

{% block title %}
    {{ title }}
    {% if location %}
        @ <a href={% url 'view_location' location.id location.unique_identifier %}>{{ location.unique_identifier }}</a>
    {% endif %}
{% endblock %}

{% block pre_container %}
<param id="placeholder_path" value="{% static 'inventory/placeholder.svg' %}" />
<div class="modal fade" id="barcode_modal" tabindex="-1" aria-labelledby="barcodeModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 674px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="barcodeModalLabel">scan a barcode</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="quagga_display"></div>
                <div id="result_strip">
                    <ul id="result_strip_thumbnails" class="thumbnails"></ul>
                    <ul class="collector"></ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="barcode_use_selected">use selected</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="camera_modal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">Take a photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <video id="camera_video" autoplay muted playsinline hidden></video>
                <canvas id="camera_present_canvas" width="100%"></canvas>
                <canvas id="camera_capture_canvas" hidden></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="camera_click_photo">Take photo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% if form.instance.id %}
{% block admin_url %}
{{ form.instance.get_admin_url }}
{% endblock %}
{% endif %}

{% block content %}
<form method="post" class="form-row" enctype="multipart/form-data">
    {% csrf_token %}
    {% bootstrap_form form %}
    {% for formset in inlines %}
        {% bootstrap_formset formset %}
    {% endfor %}
    <div class="form-group d-flex justify-content-between align-items-center">
        <button type="submit" class="btn btn-primary" >{% trans "Save" %}</button>
        {% if form.instance.pk %}
            <a href="{% url 'delete_item' form.instance.pk %}" class="btn btn-danger">
                {% trans "Delete Item" %}
            </a>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block bootstrap5_extra_head %}
    {{ block.super }}
    {{ form.media.css }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container { width: 100% !important; }
    </style>
{% endblock %}

{% block bootstrap5_extra_script %}
    {{ block.super }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
    {{ form.media.js }}
    <script>
        $(document).ready(function() {
            $('.location-select2').each(function() {
                $(this).select2({
                    theme: 'default',
                    width: '100%',
                    ajax: {
                        url: '/ajax/location-search/',
                        dataType: 'json',
                        delay: 250,
                        data: function(params) {
                            return {
                                q: params.term || '',
                                page: params.page || 1
                            };
                        },
                        processResults: function(data) {
                            return {
                                results: data.results,
                                pagination: data.pagination
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0,
                    placeholder: 'Search for a location...',
                    allowClear: true,
                    dropdownParent: $('body')
                });
            });

            $(document).on('select2:open', () => {
                document.querySelector('.select2-search__field').focus();
            });

            // This script uses a MutationObserver to ensure the button remains disabled.
            // It will override any other script that attempts to enable it.
            //const saveButton = document.querySelector('button[type="submit"]');

           
        });
    </script>
<script type="text/javascript" src="{% static 'inventory/camera.js' %}"></script>
<script type="text/javascript" src="{% static 'inventory/autocomplete.js' %}"></script>
<script type="text/javascript" src="{% static 'inventory/autocomplete_custom.js' %}"></script>
<script type="text/javascript" src="{% static 'inventory/add_image_input.js' %}"></script>
<script type="text/javascript" src="{% static 'inventory/quagga.min.js' %}"></script>
<script type="text/javascript" src="{% static 'inventory/barcodescanner.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'inventory/barcodescanner.css' %}" />
<script type="text/javascript" src="{% static 'inventory/show_measurement_unit_after_amount.js' %}"></script>
<style type="text/css">
    .itemimage_set_item div.mb-3,
    .item-location-group div.mb-3{
        margin-bottom: 0.5rem !important;
    }
    .btn{
        white-space: normal;
    }
</style>
{% endblock %}